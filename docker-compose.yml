services:
  backend:
    image: python:3.11-slim
    container_name: django_backend_prod
    working_dir: /app/my_project_ia_rag_aws
    volumes:
      - ./backend-django:/app
      - static_volume:/app/my_project_ia_rag_aws/staticfiles
      - media_volume:/app/my_project_ia_rag_aws/media
      - rag_data:/app/my_project_ia_rag_aws/db_data
    expose:
      - "8000"
    env_file:
      - .env
    environment:
      - DEBUG=0
      - SECRET_KEY=django-insecure-gz&r^km)6)@%9q^t#jr@-)k-o1!uai!^5nv-+8e*65(&u9uaf0
      - DJANGO_ALLOWED_HOSTS=18.204.231.197,54.163.220.235,localhost,127.0.0.1,*
      - PYTHONUNBUFFERED=1
      - BEDROCK_MODEL_ID=anthropic.claude-3-sonnet-20240229-v1:0
      - BEDROCK_EMBEDDING_MODEL=amazon.titan-embed-text-v2:0
      - MAX_TOKENS=4096
      - TEMPERATURE=0.7
      - TOP_P=0.9
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/rag/stats/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    command: >
      sh -c "
      apt-get update &&
      apt-get install -y gcc g++ curl wget postgresql-client &&
      pip install --upgrade pip &&
      pip install --no-cache-dir -r /app/requirements.txt &&
      cd /app/my_project_ia_rag_aws &&
      python manage.py migrate --noinput &&
      python manage.py collectstatic --noinput --clear &&
      if [ ! -f db_data/vectors.pkl ]; then
        echo 'üß† Gerando embeddings...';
        python manage.py popular_embeddings --force || echo '‚ö†Ô∏è Erro ao gerar embeddings';
      fi &&
      echo '‚úÖ Backend iniciado!' &&
      gunicorn my_project_ia_rag_aws.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 120 --access-logfile - --error-logfile -
      "

  frontend:
    image: nginx:alpine
    container_name: angular_frontend_prod
    volumes:
      - ./frontend-angular/dist/frontend_ia_rag_aws/browser:/usr/share/nginx/html:ro
      - ./frontend-angular/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

volumes:
  static_volume:
  media_volume:
  rag_data:

networks:
  app-network:
    driver: bridge