version: '3.8'

services:
  backend:
    build:
      context: ./backend-django
      dockerfile: Dockerfile
    container_name: django_backend_prod
    working_dir: /app/my_project_ia_rag_aws
    volumes:
      - ./backend-django:/app
      - static_volume:/app/my_project_ia_rag_aws/staticfiles
      - media_volume:/app/my_project_ia_rag_aws/media
      - rag_data:/app/my_project_ia_rag_aws/db_data
    expose:
      - "8000"
    env_file:
      - .env
    environment:
      # Django
      - DEBUG=0
      - SECRET_KEY=django-insecure-gz&r^km)6)@%9q^t#jr@-)k-o1!uai!^5nv-+8e*65(&u9uaf0
      - DJANGO_ALLOWED_HOSTS=18.204.231.197,54.163.220.235,ec2-54-163-220-235.compute-1.amazonaws.com,ec2-18-204-231-197.compute-1.amazonaws.com,backend,localhost,127.0.0.1,*
      - PYTHONUNBUFFERED=1
      
      # RAG Settings
      - BEDROCK_MODEL_ID=anthropic.claude-3-sonnet-20240229-v1:0
      - BEDROCK_EMBEDDING_MODEL=amazon.titan-embed-text-v2:0
      - MAX_TOKENS=4096
      - TEMPERATURE=0.7
      - TOP_P=0.9
      
      # Auto-setup
      - AUTO_POPULATE_EMBEDDINGS=true
      
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/rag/stats/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    command: ["/app/entrypoint.sh"]

  frontend:
    image: nginx:alpine
    container_name: angular_frontend_prod
    volumes:
      - ./frontend-angular/dist/frontend_ia_rag_aws/browser:/usr/share/nginx/html:ro
      - ./frontend-angular/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

volumes:
  static_volume:
  media_volume:
  rag_data:

networks:
  app-network:
    driver: bridge