<div class="chat-container">
  
  <!-- ============================================ -->
  <!-- HEADER -->
  <!-- ============================================ -->
  <div class="chat-header">
    <div class="header-content">
      <h1>ğŸ›ï¸ Assistente de Produtos</h1>
      <p>Powered by RAG + Claude Sonnet</p>
      
      <div class="header-stats" *ngIf="stats">
        <span class="stat-item">
          <span class="stat-icon">ğŸ“¦</span>
          {{ totalProdutos }} produtos
        </span>
        <span class="stat-item">
          <span class="stat-icon">ğŸ·ï¸</span>
          {{ categorias.length }} categorias
        </span>
        <span class="stat-item" [class.connected]="apiConnected" [class.disconnected]="!apiConnected">
          <span class="stat-icon">{{ apiConnected ? 'ğŸŸ¢' : 'ğŸ”´' }}</span>
          {{ apiConnected ? 'Online' : 'Offline' }}
        </span>
      </div>
    </div>

    <button 
      *ngIf="hasMessages" 
      class="clear-chat-btn" 
      (click)="limparChat()"
      title="Limpar conversa">
      ğŸ—‘ï¸
    </button>
  </div>

  <!-- ============================================ -->
  <!-- MESSAGES AREA -->
  <!-- ============================================ -->
  <div #messagesContainer class="chat-messages">
    
    <!-- Welcome Screen -->
    <div *ngIf="showWelcome" class="welcome-screen">
      <div class="welcome-icon">ğŸ¤–</div>
      <h2>ğŸ‘‹ OlÃ¡! Como posso ajudar?</h2>
      <p>Pergunte sobre produtos, preÃ§os, promoÃ§Ãµes ou caracterÃ­sticas especÃ­ficas...</p>
      
      <div class="suggestions">
        <button 
          *ngFor="let suggestion of suggestions"
          class="suggestion-chip"
          (click)="sendSuggestion(suggestion.text)"
          [title]="suggestion.category">
          <span class="suggestion-icon">{{ suggestion.icon }}</span>
          <span class="suggestion-text">{{ suggestion.text }}</span>
        </button>
      </div>

      <div class="welcome-features">
        <div class="feature-item">
          <span class="feature-icon">ğŸ”</span>
          <span>Busca inteligente</span>
        </div>
        <div class="feature-item">
          <span class="feature-icon">ğŸ’°</span>
          <span>ComparaÃ§Ã£o de preÃ§os</span>
        </div>
        <div class="feature-item">
          <span class="feature-icon">â­</span>
          <span>AvaliaÃ§Ãµes reais</span>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div *ngFor="let message of messages" 
         [class]="'message ' + message.type"
         [class.error-message]="message.error">
      
      <div class="message-avatar">
        <span *ngIf="message.type === 'user'">ğŸ‘¤</span>
        <span *ngIf="message.type === 'assistant'">ğŸ¤–</span>
        <span *ngIf="message.type === 'system'">â„¹ï¸</span>
      </div>

      <div class="message-content">
        <!-- Timestamp -->
        <div class="message-timestamp">
          {{ message.timestamp | date:'short' }}
        </div>

        <!-- Content -->
        <div class="message-text" [innerHTML]="message.content | nl2br"></div>

        <!-- Processing Time -->
        <div *ngIf="message.tempo_processamento" class="processing-time">
          âš¡ Processado em {{ formatarTempo(message.tempo_processamento) }}
        </div>

        <!-- Products Grid -->
        <div *ngIf="message.produtos && message.produtos.length > 0" 
             class="products-section">
          
          <div class="products-header">
            <h3>ğŸ“¦ {{ message.produtos.length }} Produto(s) Encontrado(s)</h3>
          </div>

          <div class="products-grid">
            <div *ngFor="let produto of message.produtos" 
                 class="product-card"
                 [class.tem-promocao]="temPromocao(produto)"
                 [class.estoque-baixo]="estoqueBaixo(produto)">
              
              <!-- Badge de PromoÃ§Ã£o -->
              <div *ngIf="temPromocao(produto)" class="promo-badge">
                ğŸ”¥ {{ calcularDesconto(produto.preco, produto.preco_promocional) }}% OFF
              </div>

              <!-- Badge de Estoque Baixo -->
              <div *ngIf="estoqueBaixo(produto)" class="stock-badge">
                âš ï¸ Ãšltimas unidades
              </div>

              <!-- Imagem do Produto -->
              <div class="product-image">
                <img 
                  *ngIf="temImagem(produto)"
                  [src]="getImagemUrl(produto)" 
                  [alt]="produto.nome"
                  (error)="onImageError($event)"
                  loading="lazy">
                <div *ngIf="!temImagem(produto)" class="no-image">
                  ğŸ“¦
                </div>
              </div>

              <!-- Nome -->
              <div class="product-name" [title]="produto.nome">
                {{ produto.nome }}
              </div>

              <!-- Marca -->
              <div *ngIf="produto.marca" class="product-brand">
                ğŸ·ï¸ {{ produto.marca }}
              </div>

              <!-- PreÃ§o -->
              <div class="product-price">
                <span *ngIf="produto.preco_promocional" class="original-price">
                  {{ formatarPreco(produto.preco) }}
                </span>
                <span class="current-price">
                  {{ formatarPreco(produto.preco_promocional || produto.preco) }}
                </span>
              </div>

              <!-- Info (AvaliaÃ§Ã£o e Estoque) -->
              <div class="product-info">
              <!-- âœ… SUBSTITUIR -->
              <span *ngIf="produto.avaliacao">
                â­ {{ formatarAvaliacao(produto.avaliacao) }}
              </span>
              <span *ngIf="!produto.avaliacao">
                â­ N/A
              </span>
              </div>

              <!-- Score de RelevÃ¢ncia -->
              <div class="product-score" *ngIf="produto.score !== undefined">
                <div class="score-bar">
                  <div class="score-fill" [style.width.%]="(produto.score || 0) * 100"></div>
                </div>
                <span class="score-text">
                  {{ produto.score_percentual || ((produto.score || 0) * 100).toFixed(0) + '%' }} relevante
                </span>
              </div>

              <!-- AÃ§Ãµes -->
              <div class="product-actions">
                <button 
                  class="btn-action btn-details"
                  (click)="verDetalhes(produto.id)"
                  title="Ver detalhes">
                  ğŸ‘ï¸ Detalhes
                </button>
                <button 
                  class="btn-action btn-cart"
                  (click)="adicionarAoCarrinho(produto)"
                  [disabled]="produto.estoque === 0"
                  title="Adicionar ao carrinho">
                  ğŸ›’ Comprar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="message assistant">
      <div class="message-avatar">ğŸ¤–</div>
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- INPUT AREA -->
  <!-- ============================================ -->
  <div class="chat-input-container">
    <div class="input-wrapper">
      <textarea
        class="chat-input"
        placeholder="Digite sua mensagem... (Enter para enviar)"
        [(ngModel)]="inputMessage"
        (keypress)="onKeyPress($event)"
        [disabled]="isLoading"
        rows="1"
        maxlength="500">
      </textarea>
      
      <div class="input-counter" *ngIf="inputMessage.length > 400">
        {{ inputMessage.length }}/500
      </div>
    </div>

    <button
      class="send-button"
      (click)="sendMessage()"
      [disabled]="!canSend"
      [title]="!apiConnected ? 'API desconectada' : 'Enviar mensagem'">
      <span *ngIf="!isLoading">ğŸ“¤ Enviar</span>
      <span *ngIf="isLoading">â³ Enviando...</span>
    </button>
  </div>
</div>
 